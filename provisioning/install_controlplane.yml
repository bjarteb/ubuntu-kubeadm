---

- hosts: all
  tasks:
    - name: install python
      raw: test -e /usr/bin/python3 || (apt update && apt install -y python3-minimal)
      register: test
      changed_when: test.stdout | bool

    - name: install initial packages
      vars:
        packages:
          - apt-transport-https
          - ca-certificates
          - software-properties-common
      apt:
        name: "{{ packages }}"
        state: "present"
        update_cache: true

    - name: get upstream APT GPG key
      apt_key:
        url: "https://download.docker.com/linux/ubuntu/gpg"
        state: "present"

    - name: configure upstream APT repository
      apt_repository:
        repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu bionic stable"
        state: "present"
        update_cache: true

    - name: install packages
      vars:
        packages:
          - jq
          - htop
          - traceroute
          - iftop
          - python3-pip
          - docker-ce
          - docker-ce-cli
          - containerd.io
      apt:
        name: "{{ packages }}"
        state: "present"
        update_cache: true

    - name: remove default host lookup
      lineinfile:
        path: "/etc/hosts"
        regexp: "127.0.1.1.*"
        state: "absent"

    - name: ssh-key configuration
      copy:
        src: files/id_rsa.pub
        dest: /home/vagrant
        owner: vagrant
        group: vagrant

    - name: authorized keys
      shell: "cat /home/vagrant/id_rsa.pub >> /home/vagrant/.ssh/authorized_keys"
      changed_when: false

    - name: configure kernel params
      sysctl:
        name: "{{ item }}"
        value: 1
        sysctl_set: yes
        state: present
        reload: yes
      loop:
        - net.bridge.bridge-nf-call-ip6tables
        - net.bridge.bridge-nf-call-iptables
        - net.ipv4.ip_nonlocal_bind
        - net.ipv4.ip_forward

    - name: Remove swapfile from /etc/fstab
      mount:
        name: swap
        fstype: swap
        state: absent

    - name: Disable swap
      shell: swapoff -a
      when: ansible_swaptotal_mb > 0

    - name: Copy docker config file
      copy:
        src: etc-docker-daemon.json
        dest: /etc/docker/daemon.json

    - name: Creates directory
      file:
        path: /etc/systemd/system/docker.service.d
        state: directory

    - name: Restart docker
      systemd:
        state: restarted
        daemon_reload: yes
        name: docker
